<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµµæœ¬ï¼šã‚¢ã‚¤ãƒ‡ã‚¢å¦–ç²¾ãƒ”ã‚³ã¨ã€Œä¸–ç•Œã¸ã®æ‰‰ã€</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            background-color: #2d333b; /* GitHub Dark Dimmed */
            color: #adbac7;
        }

        .book-container {
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            background: #ffffff;
            color: #333;
        }

        /* Animations */
        .float-anim { animation: float 3s ease-in-out infinite; }
        .pulse-anim { animation: pulse 2s infinite; }
        .spin-slow { animation: spin 10s linear infinite; }
        .slide-up { animation: slideUp 0.5s ease-out forwards; }

        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.8; } }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Loader */
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #6366f1;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden flex items-center justify-center bg-gray-900">

    <div id="app" class="relative w-full max-w-5xl h-[90vh] book-container rounded-2xl overflow-hidden flex flex-col md:flex-row">
        
        <div id="illustration-area" class="w-full md:w-1/2 h-1/2 md:h-full bg-indigo-50 relative overflow-hidden flex items-center justify-center border-b-4 md:border-b-0 md:border-r-4 border-gray-100 transition-colors duration-700">
            <div id="scene-container" class="relative w-full h-full"></div>
            
            <div class="absolute bottom-4 right-4 flex flex-col gap-2 z-30">
                <button onclick="openChat()" class="bg-white/90 backdrop-blur text-indigo-600 p-3 rounded-full shadow-lg hover:scale-110 transition-transform flex items-center gap-2 border-2 border-indigo-200">
                    <i class="fas fa-comment-dots text-xl"></i> <span class="text-sm font-bold hidden md:inline">Geminiå…ˆç”Ÿã«èã</span>
                </button>
            </div>
        </div>

        <div class="w-full md:w-1/2 h-1/2 md:h-full p-8 flex flex-col justify-between bg-white relative z-10">
            <div>
                <div class="flex justify-between items-center mb-4">
                    <span id="page-number" class="text-gray-400 font-bold text-sm">Page 1</span>
                    <div class="flex gap-2">
                        <button onclick="resetApiKey()" class="text-xs bg-gray-100 px-2 py-1 rounded hover:bg-gray-200"><i class="fas fa-key"></i> Keyè¨­å®š</button>
                        <button onclick="playTTS()" id="tts-btn" class="text-xs bg-indigo-100 text-indigo-600 px-3 py-1 rounded-full font-bold hover:bg-indigo-200 flex items-center gap-1">
                            <i class="fas fa-volume-up"></i> <span>èª­ã‚€</span>
                        </button>
                    </div>
                </div>
                
                <h2 id="page-title" class="text-2xl md:text-3xl font-black text-gray-800 mb-6 min-h-[3rem] leading-tight">ã‚¿ã‚¤ãƒˆãƒ«</h2>
                <div id="page-text" class="text-gray-600 text-lg leading-loose font-medium slide-up"></div>
            </div>

            <div class="flex justify-between items-center mt-6 pt-6 border-t border-gray-100">
                <button onclick="prevPage()" id="prev-btn" class="px-6 py-3 bg-gray-100 text-gray-500 rounded-full font-bold hover:bg-gray-200 transition-colors disabled:opacity-50">
                    <i class="fas fa-arrow-left"></i> å‰ã¸
                </button>
                <button onclick="nextPage()" id="next-btn" class="px-6 py-3 bg-indigo-600 text-white rounded-full font-bold hover:bg-indigo-700 shadow-lg transition-transform transform hover:scale-105">
                    æ¬¡ã¸ <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="apikey-modal" class="fixed inset-0 bg-black/90 z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl p-8 text-center">
            <div class="text-4xl mb-4">ğŸ”‘</div>
            <h2 class="text-xl font-bold mb-2">Gemini APIã‚­ãƒ¼ãŒå¿…è¦ã§ã™</h2>
            <p class="text-gray-500 text-sm mb-4">ã“ã®çµµæœ¬ã¯AIã‚’ä½¿ã£ã¦å‹•ãã¾ã™ã€‚<br>ã‚­ãƒ¼ã¯ãƒ–ãƒ©ã‚¦ã‚¶å†…ã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™ã€‚</p>
            <input type="password" id="apikey-input" placeholder="AIzaSy..." class="w-full border p-3 rounded mb-4">
            <button onclick="saveApiKey()" class="w-full bg-indigo-600 text-white font-bold py-3 rounded hover:bg-indigo-700">å†’é™ºã‚’å§‹ã‚ã‚‹</button>
            <a href="https://aistudio.google.com/app/apikey" target="_blank" class="block mt-4 text-xs text-indigo-500 underline">ã‚­ãƒ¼ã‚’å–å¾—ã™ã‚‹ (Google)</a>
        </div>
    </div>

    <div id="chat-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden flex flex-col h-[60vh]">
            <div class="bg-indigo-600 p-4 flex justify-between items-center text-white">
                <span class="font-bold">Geminiå…ˆç”Ÿ</span>
                <button onclick="closeChat()"><i class="fas fa-times"></i></button>
            </div>
            <div id="chat-messages" class="flex-1 p-4 overflow-y-auto bg-gray-50 space-y-4"></div>
            <div class="p-4 border-t">
                <div class="flex gap-2">
                    <input type="text" id="chat-input" class="flex-1 border rounded-full px-4 py-2" placeholder="è³ªå•ã—ã¦ã­" onkeypress="if(event.key === 'Enter') sendMessage()">
                    <button onclick="sendMessage()" class="bg-indigo-600 text-white rounded-full w-10 h-10"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA & STORY ---
        const pages = [
            {
                title: "ã‚¢ã‚¤ãƒ‡ã‚¢å¦–ç²¾ãƒ”ã‚³ã¨\nä¸–ç•Œã¸ã®æ‰‰",
                text: "ã“ã‚Œã¯ã€ã¾ã èª°ã«ã‚‚çŸ¥ã‚‰ã‚Œã¦ã„ãªã„å°ã•ãªã‚¢ã‚¤ãƒ‡ã‚¢ã€Œãƒ”ã‚³ã€ãŒã€Geminiå…ˆç”Ÿã¨åŠ›ã‚’åˆã‚ã›ã¦ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã¨ã„ã†åºƒã„ä¸–ç•Œã¸é£›ã³å‡ºã™ã¾ã§ã®å†’é™ºã®ãŠè©±ã€‚",
                scene: "cover",
                bg: "bg-indigo-50"
            },
            {
                title: "ã¼ãã¯ãƒ”ã‚³ï¼å½¢ãŒãªã„ã‚“ã ",
                text: "ã€Œã‚ãƒ¼ã‚ã€ã¼ãã¯é¢ç™½ã„ãŠè©±ã®ã‚¢ã‚¤ãƒ‡ã‚¢ãªã‚“ã ã‘ã©ãªãã€<br>ãƒ”ã‚³ã¯é ­ã®ä¸­ã§ãƒ•ãƒ¯ãƒ•ãƒ¯æµ®ã‹ã‚“ã§ã„ã¾ã—ãŸã€‚<br>ã§ã‚‚ã€ãƒ”ã‚³ã«ã¯ä½“ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã ã‹ã‚‰ã€èª°ã‹ã«èª­ã‚“ã§ã‚‚ã‚‰ã†ã“ã¨ãŒã§ããªã„ã®ã§ã™ã€‚",
                scene: "idea",
                bg: "bg-yellow-50"
            },
            {
                title: "Geminiå…ˆç”Ÿã«ãŠé¡˜ã„ï¼",
                text: "ãã“ã§ãƒ”ã‚³ã¯ã€ç‰©çŸ¥ã‚Šã®é­”æ³•ä½¿ã„ã€ŒGeminiå…ˆç”Ÿã€ã«ç›¸è«‡ã—ã¾ã—ãŸã€‚<br>ã€Œå…ˆç”Ÿï¼ã¼ãã‚’çµµæœ¬ã«ã—ã¦ãã ã•ã„ï¼ã€<br>å…ˆç”Ÿã¯å„ªã—ãå¾®ç¬‘ã‚“ã§è¨€ã„ã¾ã—ãŸã€‚<br>ã€Œã‚ˆã—ã€ã‚­ãƒŸã‚’ã€HTMLã€ã¨ã„ã†é­”æ³•ã®è¨€è‘‰ã§åŒ…ã‚“ã§ã‚ã’ã‚ˆã†ã€",
                scene: "consult",
                bg: "bg-purple-50"
            },
            {
                title: "é­”æ³•ã®è¨€è‘‰ã§å¤‰èº«ï¼",
                text: "ã‚«ã‚¿ã‚«ã‚¿ã‚«ã‚¿â€¦â€¦ãƒƒã‚¿ãƒ¼ãƒ³ï¼<br>Geminiå…ˆç”ŸãŒæ–ï¼ˆã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ï¼‰ã‚’æŒ¯ã‚‹ã¨ã€ãƒ”ã‚³ã¯çœŸã£ç™½ãªã€ãƒ•ã‚¡ã‚¤ãƒ«ã€ã«å¤‰èº«ã—ã¾ã—ãŸã€‚<br>ã€Œã‚ã‚ï¼ã“ã‚ŒãŒã¼ãã®ä½“ï¼Ÿ index.html ã£ã¦æ›¸ã„ã¦ã‚ã‚‹ï¼ã€<br>ã“ã‚Œã§ãƒ”ã‚³ã¯ã€ãƒ‘ã‚½ã‚³ãƒ³ã®ä¸­ã«ä½ã‚ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚",
                scene: "coding",
                bg: "bg-blue-50"
            },
            {
                title: "ã§ã‚‚ã€ã¾ã èª°ã‚‚æ¥ãªã„â€¦",
                text: "ã‘ã‚Œã©ã€ãƒ”ã‚³ã¯ã¾ã ãƒ‘ã‚½ã‚³ãƒ³ã®ä¸­ã«ã²ã¨ã‚Šã¼ã£ã¡ã€‚<br>ã€Œã“ã‚Œã˜ã‚ƒã‚ã€ä¸–ç•Œä¸­ã®äººã«è¦‹ã¦ã‚‚ã‚‰ãˆãªã„ã‚ˆâ€¦ã€<br>ã™ã‚‹ã¨å…ˆç”ŸãŒè¨€ã„ã¾ã—ãŸã€‚<br>ã€Œãã‚Œãªã‚‰ã€GitHubï¼ˆã‚®ãƒƒãƒˆãƒãƒ–ï¼‰ã®æ£®ã€ã¸è¡Œã“ã†ã€‚ãã“ã«ã¯ä¸–ç•Œã¸ç¶šãæ‰‰ãŒã‚ã‚‹ã‚“ã ã€",
                scene: "lonely",
                bg: "bg-gray-100"
            },
            {
                title: "GitHubã®æ£®ã¸å‡ºç™ºï¼",
                text: "æ£®ã«ã¯ã€ãƒªãƒã‚¸ãƒˆãƒªã€ã¨ã„ã†åå‰ã®ã€æœ¬æ£šã®æœ¨ãŒãŸãã•ã‚“ç”Ÿãˆã¦ã„ã¾ã™ã€‚<br>ãƒ”ã‚³ã¯è‡ªåˆ†å°‚ç”¨ã®æœ¨ï¼ˆNew Repositoryï¼‰ã‚’ä½œã‚Šã¾ã—ãŸã€‚<br>ã€Œã“ã“ãŒã¼ãã®æ–°ã—ã„ãŠå®¶ã ã­ï¼ã€<br>ãƒ”ã‚³ã¯è‡ªåˆ†ã®ä½“ã‚’ã€ãã®æœ¨ã®ä¸Šã«ãˆã„ã£ã¨ä¹—ã›ã¾ã—ãŸï¼ˆUploadï¼‰ã€‚",
                scene: "github_forest",
                bg: "bg-green-50"
            },
            {
                title: "æœ€å¾Œã®ä»•ä¸Šã’ã€ã‚¹ã‚¤ãƒƒãƒã‚ªãƒ³",
                text: "æœ¨ã®ä¸Šã«ã¯ã€Settingsï¼ˆè¨­å®šï¼‰ã€ã¨ã„ã†æ­¯è»ŠãŒã‚ã‚Šã¾ã™ã€‚<br>ãã‚Œã‚’å›ã—ã¦ã€ã€Pagesã€ã¨ã„ã†ã‚¹ã‚¤ãƒƒãƒã‚’ãƒ‘ãƒãƒ³ï¼ã¨å…¥ã‚Œã¾ã—ãŸã€‚<br>ã™ã‚‹ã¨â€¦â€¦æœ¨ãŒå…‰ã‚Šå§‹ã‚ã¾ã—ãŸï¼",
                scene: "settings",
                bg: "bg-orange-50"
            },
            {
                title: "ã‚ã¶ãªã„ï¼ã‚«ã‚®ã®ç§˜å¯†",
                text: "ã€Œå¾…ã£ã¦ï¼ã€å…ˆç”ŸãŒå«ã³ã¾ã—ãŸã€‚ã€Œãã®ã¾ã¾ã˜ã‚ƒã€å¤§äº‹ãªã€APIã‚­ãƒ¼ã€ãŒä¸¸è¦‹ãˆã ã‚ˆï¼ã€<br>æ³¥æ£’ãŒå…¥ã‚‰ãªã„ã‚ˆã†ã«ã€å…ˆç”Ÿã¯ç‰¹åˆ¥ãªé­”æ³•ï¼ˆãƒªãƒ•ã‚¡ãƒ©ãƒ¼åˆ¶é™ï¼‰ã‚’ã‹ã‘ã¾ã—ãŸã€‚<br>ã€Œã“ã‚Œã§ã€ã“ã®å ´æ‰€ã‹ã‚‰ã—ã‹é­”æ³•ã¯ä½¿ãˆãªã„ã‚ˆã€‚å®‰å¿ƒã ã­ã€",
                scene: "security",
                bg: "bg-red-50"
            },
            {
                title: "ä¸–ç•Œã¸ã®æ‰‰ãŒé–‹ã„ãŸï¼",
                text: "æº–å‚™å®Œäº†ï¼<br>ã™ã‚‹ã¨ã€ãƒ”ã‚³ã®é ­ä¸Šã«è™¹è‰²ã®ã€URLã€ãŒç¾ã‚Œã¾ã—ãŸã€‚<br>ãã®URLã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ä¸–ç•Œä¸­ã®ã©ã“ã‹ã‚‰ã§ã‚‚ã€ãƒ”ã‚³ã®å§¿ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«ãªã£ãŸã®ã§ã™ï¼",
                scene: "publish",
                bg: "bg-sky-100"
            },
            {
                title: "ã¤ãªãŒã‚‹ä¸–ç•Œ",
                text: "ã€Œè¦‹ã¦ï¼æ—¥æœ¬ã‹ã‚‰ã‚‚ã€ã‚¢ãƒ¡ãƒªã‚«ã‹ã‚‰ã‚‚ã€ã¼ããŒè¦‹ãˆã¦ã‚‹ï¼ã€<br>ãƒ”ã‚³ã¯å¤§å–œã³ã€‚<br>Geminiå…ˆç”Ÿã¨GitHubã®æ£®ã®ãŠã‹ã’ã§ã€å°ã•ãªã‚¢ã‚¤ãƒ‡ã‚¢ã ã£ãŸãƒ”ã‚³ã¯ã€ä¸–ç•Œä¸­ã®å‹é”ã¨éŠã¹ã‚‹ã‚ˆã†ã«ãªã£ãŸã®ã§ã—ãŸã€‚",
                scene: "world",
                bg: "bg-indigo-100"
            }
        ];

        let currentPage = 0;
        let apiKey = localStorage.getItem("gemini_api_key");
        let audioContext = null;

        // --- RENDER LOGIC ---
        function renderPage() {
            const page = pages[currentPage];
            document.getElementById('page-number').innerText = `Page ${currentPage + 1} / ${pages.length}`;
            document.getElementById('page-title').innerText = page.title;
            document.getElementById('page-text').innerHTML = page.text;
            document.getElementById('illustration-area').className = `w-full md:w-1/2 h-1/2 md:h-full relative overflow-hidden flex items-center justify-center transition-colors duration-700 ${page.bg}`;
            
            document.getElementById('prev-btn').disabled = currentPage === 0;
            document.getElementById('next-btn').innerHTML = currentPage === pages.length - 1 ? 'ãŠã—ã¾ã„' : 'æ¬¡ã¸ <i class="fas fa-arrow-right"></i>';

            renderScene(page.scene);
        }

        function nextPage() { if(currentPage < pages.length - 1) { currentPage++; renderPage(); } }
        function prevPage() { if(currentPage > 0) { currentPage--; renderPage(); } }

        // --- VISUALS (SVG Generative) ---
        function renderScene(scene) {
            const container = document.getElementById('scene-container');
            const W = 300; const H = 300; // coordinate space
            let html = '';

            // Characters
            const Piko = (x, y, emotion="happy") => {
                const color = emotion === 'file' ? '#FFF' : '#FFD700';
                const shape = emotion === 'file' ? 'rounded-none border-2 border-gray-300' : 'rounded-full';
                const eye = emotion === 'file' ? 't-1/3' : 'top-1/3';
                return `<div class="absolute float-anim flex items-center justify-center shadow-lg" style="left:${x}%; top:${y}%; width:80px; height:80px; background:${color}; ${shape}; transition:all 0.5s;">
                    <div class="absolute w-2 h-2 bg-black rounded-full left-4 ${eye}"></div>
                    <div class="absolute w-2 h-2 bg-black rounded-full right-4 ${eye}"></div>
                    <div class="absolute w-4 h-2 bg-pink-300 rounded-full top-1/2 opacity-50"></div>
                    ${emotion === 'file' ? '<div class="absolute bottom-2 text-xs text-gray-400 font-mono">.html</div>' : ''}
                </div>`;
            };
            
            const Gemini = (x, y) => `<div class="absolute pulse-anim text-6xl text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-600 font-black" style="left:${x}%; top:${y}%;">âœ¦</div>`;
            
            const Cloud = (x, y) => `<div class="absolute text-gray-200 text-9xl opacity-50" style="left:${x}%; top:${y}%;"><i class="fas fa-cloud"></i></div>`;
            
            const Tree = (x, y) => `<div class="absolute flex flex-col items-center" style="left:${x}%; top:${y}%;">
                <div class="w-24 h-24 bg-green-500 rounded-full shadow-lg relative flex items-center justify-center text-white text-2xl"><i class="fas fa-book"></i></div>
                <div class="w-4 h-20 bg-amber-700"></div>
            </div>`;

            // Scene Logic
            switch(scene) {
                case 'cover':
                    html = Piko(40, 40) + Gemini(70, 20) + `<div class="absolute bottom-10 text-gray-400 font-bold">START â–¶</div>`;
                    break;
                case 'idea':
                    html = `<div class="absolute inset-0 bg-gray-900 opacity-10"></div>` + Piko(40, 40) + `<div class="absolute top-20 right-20 text-4xl">ğŸ’­</div>`;
                    break;
                case 'consult':
                    html = Piko(20, 50) + Gemini(60, 40) + `<div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-4xl">ğŸ—£ï¸</div>`;
                    break;
                case 'coding':
                    html = `<div class="absolute inset-0 font-mono text-xs text-blue-200 opacity-30 p-4 break-words overflow-hidden">&lt;html&gt;&lt;body&gt;&lt;div&gt;...</div>` + 
                           Piko(40, 40, 'file') + Gemini(80, 10);
                    break;
                case 'lonely':
                     html = `<div class="absolute w-60 h-40 border-4 border-gray-400 rounded-lg top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 flex items-center justify-center bg-gray-800"></div>` + 
                            Piko(45, 45, 'file');
                    break;
                case 'github_forest':
                    html = Tree(20, 30) + Tree(70, 40) + Tree(40, 60) + Piko(42, 20, 'file');
                    break;
                case 'settings':
                    html = `<div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-40 h-40 bg-orange-200 rounded-full flex items-center justify-center spin-slow"><i class="fas fa-cog text-6xl text-orange-500"></i></div>` + 
                           `<div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-white font-bold text-xl">ON!</div>`;
                    break;
                case 'security':
                    html = `<div class="absolute inset-0 flex items-center justify-center"><i class="fas fa-shield-alt text-9xl text-red-200"></i></div>` + 
                           `<div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-4xl">ğŸ”’</div>` + Piko(40, 60, 'file');
                    break;
                case 'publish':
                    html = `<div class="absolute inset-0 bg-gradient-to-b from-sky-200 to-transparent"></div>` + 
                           `<div class="absolute top-10 w-full text-center font-mono text-indigo-600 bg-white/50 py-2">https://user.github.io/piko</div>` + Piko(40, 40);
                    break;
                case 'world':
                    html = `<div class="absolute w-60 h-60 bg-blue-200 rounded-full top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 border-4 border-white opacity-50"></div>` + 
                           Piko(40, 35) + `<div class="absolute top-20 left-20">ğŸ‘‹</div><div class="absolute bottom-20 right-20">ğŸ‘‹</div>`;
                    break;
            }
            container.innerHTML = html;
        }

        // --- GEMINI API & UTILS ---
        function checkApiKey() {
            if (!apiKey) document.getElementById('apikey-modal').classList.remove('hidden');
        }

        function saveApiKey() {
            const val = document.getElementById('apikey-input').value.trim();
            if(val) { localStorage.setItem("gemini_api_key", val); apiKey = val; document.getElementById('apikey-modal').classList.add('hidden'); }
        }

        function resetApiKey() {
            if(confirm("ã‚­ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) { localStorage.removeItem("gemini_api_key"); location.reload(); }
        }

        async function callGemini(text, systemInstruction) {
            if(!apiKey) { checkApiKey(); return "ã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ã­"; }
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: text }] }], systemInstruction: { parts: [{ text: systemInstruction }] } })
                });
                const data = await res.json();
                return data.candidates[0].content.parts[0].text;
            } catch(e) { return "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"; }
        }

        async function callGeminiTTS(text) {
             if(!apiKey) return null;
             const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
             try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: text }] }], generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Puck" } } } } })
                });
                const data = await res.json();
                return data.candidates[0].content.parts[0].inlineData.data;
             } catch(e) { return null; }
        }

        async function playTTS() {
            const btn = document.getElementById('tts-btn');
            btn.innerText = "ç”Ÿæˆä¸­...";
            const audioData = await callGeminiTTS(pages[currentPage].text.replace(/<[^>]*>/g, ''));
            if(audioData) {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const bytes = Uint8Array.from(atob(audioData), c => c.charCodeAt(0));
                const buffer = await audioCtx.decodeAudioData(bytes.buffer);
                const source = audioCtx.createBufferSource();
                source.buffer = buffer;
                source.connect(audioCtx.destination);
                source.start(0);
                btn.innerText = "å†ç”Ÿä¸­";
                source.onended = () => btn.innerHTML = '<i class="fas fa-volume-up"></i> èª­ã‚€';
            } else {
                btn.innerText = "ã‚¨ãƒ©ãƒ¼";
            }
        }

        // --- CHAT ---
        function openChat() { document.getElementById('chat-modal').classList.remove('hidden'); }
        function closeChat() { document.getElementById('chat-modal').classList.add('hidden'); }
        
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const msg = input.value;
            if(!msg) return;
            const box = document.getElementById('chat-messages');
            box.innerHTML += `<div class="text-right"><span class="bg-indigo-100 p-2 rounded inline-block text-sm">${msg}</span></div>`;
            input.value = '';
            
            box.innerHTML += `<div class="text-left text-gray-400 text-xs" id="loading">è€ƒãˆä¸­...</div>`;
            const reply = await callGemini(msg, "You are 'Gemini-sensei', a wise and kind AI wizard teaching a user how to publish websites on GitHub. Keep answers short, encouraging, and simple.");
            document.getElementById('loading').remove();
            box.innerHTML += `<div class="text-left"><span class="bg-indigo-600 text-white p-2 rounded inline-block text-sm shadow">${reply}</span></div>`;
            box.scrollTop = box.scrollHeight;
        }

        // Init
        renderPage();
        checkApiKey();
    </script>
</body>
</html>