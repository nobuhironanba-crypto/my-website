<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµµæœ¬ï¼šã‚·ãƒ¼ã‚ªãƒ¼ãƒ„ãƒ¼ãã‚“ã®ã‚·ãƒ¥ãƒ¯ã‚·ãƒ¥ãƒ¯å¤‰èº«ã®æ—…</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;900&display=swap');
        
        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            background-color: #f0f9ff;
        }

        .book-shadow {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .character-float {
            animation: float 3s ease-in-out infinite;
        }

        .character-shake {
            animation: shake 0.5s ease-in-out infinite;
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        @keyframes shake {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Loading Spinner */
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Modal Transitions */
        .modal-hidden { display: none; }
        .modal-flex { display: flex; }
        
        /* Quiz Option Hover */
        .quiz-option:hover { transform: scale(1.02); }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden flex items-center justify-center bg-sky-100">

    <div id="app" class="relative w-full max-w-5xl h-[90vh] bg-white rounded-2xl book-shadow overflow-hidden flex flex-col md:flex-row">
        
        <div id="illustration-area" class="w-full md:w-1/2 h-1/2 md:h-full bg-blue-50 relative overflow-hidden flex items-center justify-center border-b-4 md:border-b-0 md:border-r-4 border-sky-100 transition-colors duration-500 group">
            <div id="scene-container" class="relative w-full h-full p-4"></div>
            
            <div class="absolute bottom-4 right-4 flex flex-col gap-2 z-30">
                <button onclick="openChat()" class="bg-white/90 backdrop-blur text-sky-600 p-3 rounded-full shadow-lg hover:scale-110 transition-transform flex items-center gap-2 border-2 border-sky-200 group-hover:animate-bounce">
                    <i class="fas fa-comment-dots text-xl"></i>
                    <span class="font-bold text-sm hidden md:inline">è³ªå•ã™ã‚‹</span>
                </button>
                
                <button onclick="startQuiz()" class="bg-yellow-400/90 backdrop-blur text-white p-3 rounded-full shadow-lg hover:bg-yellow-500 hover:scale-110 transition-all flex items-center gap-2 border-2 border-yellow-200">
                    <i class="fas fa-question-circle text-xl"></i>
                    <span class="font-bold text-sm hidden md:inline">ã‚¯ã‚¤ã‚º</span>
                </button>
            </div>
        </div>

        <div class="w-full md:w-1/2 h-1/2 md:h-full p-6 md:p-8 flex flex-col justify-between bg-white relative z-10 overflow-y-auto">
            <div>
                <div class="flex justify-between items-center mb-2 flex-wrap gap-2">
                    <span id="page-number" class="text-sky-400 font-bold text-lg">Page 1 / 11</span>
                    <div class="flex items-center gap-2">
                        <button onclick="resetApiKey()" title="APIã‚­ãƒ¼ã‚’å†è¨­å®š" class="text-xs bg-gray-100 text-gray-500 px-3 py-1 rounded-full font-bold hover:bg-gray-200 transition-colors flex items-center gap-1">
                            <i class="fas fa-key"></i>
                        </button>
                        <button onclick="toggleEnglish()" id="translate-btn" class="text-xs bg-indigo-100 text-indigo-600 px-3 py-1 rounded-full font-bold hover:bg-indigo-200 transition-colors flex items-center gap-1">
                            <i class="fas fa-language"></i> <span>English</span>
                        </button>
                        <button onclick="playTTS()" id="tts-btn" class="text-xs bg-pink-100 text-pink-600 px-3 py-1 rounded-full font-bold hover:bg-pink-200 transition-colors flex items-center gap-1">
                            <i class="fas fa-volume-up"></i> <span>èª­ã‚€</span>
                        </button>
                    </div>
                </div>
                
                <h2 id="page-title" class="text-2xl md:text-3xl font-black text-gray-800 mb-4 min-h-[3rem]">ã‚¿ã‚¤ãƒˆãƒ«</h2>
                <div id="page-text" class="text-gray-700 text-lg md:text-xl leading-loose font-medium fade-in pb-4">
                    </div>
            </div>

            <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-100">
                <button onclick="prevPage()" id="prev-btn" class="px-6 py-3 bg-gray-200 text-gray-600 rounded-full font-bold hover:bg-gray-300 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                    <i class="fas fa-arrow-left"></i> å‰ã¸
                </button>
                <button onclick="nextPage()" id="next-btn" class="px-6 py-3 bg-sky-500 text-white rounded-full font-bold hover:bg-sky-600 shadow-lg transition-transform transform hover:scale-105 flex items-center gap-2">
                    æ¬¡ã¸ <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="apikey-modal" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-md">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-8 flex flex-col items-center text-center">
            <div class="w-16 h-16 bg-sky-100 rounded-full flex items-center justify-center text-sky-500 text-2xl mb-4">
                <i class="fas fa-robot"></i>
            </div>
            <h2 class="text-2xl font-black text-gray-800 mb-2">è¨­å®šãŒå¿…è¦ã§ã™</h2>
            <p class="text-gray-600 mb-6 text-sm leading-relaxed">
                ã“ã®çµµæœ¬ã¯AIï¼ˆGeminiï¼‰ã¨ãŠè©±ã—ã§ãã¾ã™ã€‚<br>
                Googleã®APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¦ãã ã•ã„ã€‚<br>
                <span class="text-xs text-gray-400 mt-2 block">â€»ã‚­ãƒ¼ã¯ã‚ãªãŸã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ã ã‘ä¿å­˜ã•ã‚Œã¾ã™ã€‚<br>ã‚µãƒ¼ãƒãƒ¼ã«ã¯é€ä¿¡ã•ã‚Œã¾ã›ã‚“ã€‚</span>
            </p>
            
            <input type="password" id="apikey-input" placeholder="ã“ã“ã«APIã‚­ãƒ¼ã‚’è²¼ã‚Šä»˜ã‘ (AIzaSy...)" 
                   class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 mb-4 focus:outline-none focus:border-sky-500 focus:ring-4 focus:ring-sky-100 transition-all font-mono text-sm">
            
            <button onclick="saveApiKey()" class="w-full bg-gradient-to-r from-sky-400 to-blue-500 text-white font-bold py-3 rounded-xl hover:from-sky-500 hover:to-blue-600 transition-all shadow-lg transform hover:scale-105">
                å†’é™ºã‚’ã¯ã˜ã‚ã‚‹ï¼ ğŸš€
            </button>
            
            <div class="mt-6 text-xs text-gray-400">
                <a href="https://aistudio.google.com/app/apikey" target="_blank" class="underline hover:text-sky-500">APIã‚­ãƒ¼ã‚’æŒã£ã¦ã„ãªã„å ´åˆã¯ã“ã¡ã‚‰</a>
            </div>
        </div>
    </div>

    <div id="chat-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden flex flex-col h-[60vh] transition-all transform scale-90 opacity-0" id="chat-content">
            <div class="bg-sky-400 p-4 flex justify-between items-center text-white">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-white rounded-full flex items-center justify-center text-sky-500 text-xs font-bold border-2 border-sky-300">CO<sub>2</sub></div>
                    <span class="font-bold text-lg">ã‚·ãƒ¼ã‚ªãƒ¼ãƒ„ãƒ¼ãã‚“ã«è³ªå•</span>
                </div>
                <button onclick="closeChat()" class="hover:bg-sky-500 p-1 rounded transition-colors"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <div id="chat-messages" class="flex-1 p-4 overflow-y-auto bg-gray-50 space-y-4">
                </div>

            <div class="p-4 bg-white border-t border-gray-100">
                <div class="flex gap-2">
                    <input type="text" id="chat-input" placeholder="ä¾‹ï¼šãªã‚“ã§æ°´ãŒãã‚‰ã„ãªã®ï¼Ÿ" 
                           class="flex-1 border border-gray-300 rounded-full px-4 py-2 focus:outline-none focus:border-sky-400 focus:ring-2 focus:ring-sky-100 text-sm"
                           onkeypress="if(event.key === 'Enter') sendMessage()">
                    <button onclick="sendMessage()" id="send-btn" class="bg-sky-500 text-white rounded-full w-10 h-10 flex items-center justify-center hover:bg-sky-600 transition-colors shadow-md">
                        <i class="fas fa-paper-plane text-sm"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="quiz-modal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[80vh]" id="quiz-content">
            <div class="bg-yellow-400 p-4 flex justify-between items-center text-white">
                <div class="flex items-center gap-2">
                    <i class="fas fa-star text-2xl"></i>
                    <span class="font-bold text-lg">ç§‘å­¦ã‚¯ã‚¤ã‚ºï¼</span>
                </div>
                <button onclick="closeQuiz()" class="hover:bg-yellow-500 p-1 rounded transition-colors"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <div id="quiz-body" class="p-6 overflow-y-auto">
                <div id="quiz-loading" class="flex flex-col items-center justify-center py-10 text-gray-500">
                    <span class="loader border-yellow-200 border-t-yellow-500 w-10 h-10 mb-4"></span>
                    <p>AIãŒã‚¯ã‚¤ã‚ºã‚’ä½œã£ã¦ã„ã¾ã™...</p>
                </div>
                
                <div id="quiz-question-container" class="hidden">
                    <p id="quiz-question" class="text-xl font-bold text-gray-800 mb-6 leading-relaxed">ã“ã“ã«å•é¡ŒãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
                    <div id="quiz-options" class="space-y-3">
                        </div>
                </div>

                <div id="quiz-result" class="hidden mt-6 bg-gray-50 p-4 rounded-xl border border-gray-200">
                    <div id="quiz-result-title" class="font-black text-2xl mb-2 text-center"></div>
                    <p id="quiz-explanation" class="text-gray-700 leading-relaxed"></p>
                    <button onclick="closeQuiz()" class="mt-4 w-full bg-yellow-400 text-white font-bold py-3 rounded-xl hover:bg-yellow-500 transition-colors">ã¨ã˜ã‚‹</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- GEMINI API CONFIG (SECURE MODE) ---
        // API key is retrieved from localStorage, not hardcoded.
        let apiKey = localStorage.getItem("gemini_api_key");

        // --- API KEY MANAGEMENT ---
        function checkApiKey() {
            if (!apiKey) {
                document.getElementById('apikey-modal').classList.remove('hidden');
            }
        }

        function saveApiKey() {
            const input = document.getElementById('apikey-input');
            const key = input.value.trim();
            if (key) {
                localStorage.setItem("gemini_api_key", key);
                apiKey = key;
                document.getElementById('apikey-modal').classList.add('hidden');
            } else {
                alert("APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼");
            }
        }

        function resetApiKey() {
            if(confirm("APIã‚­ãƒ¼ã‚’å‰Šé™¤ã—ã¦å†å…¥åŠ›ã—ã¾ã™ã‹ï¼Ÿ")) {
                localStorage.removeItem("gemini_api_key");
                apiKey = null;
                location.reload();
            }
        }

        // Generic Text Generation
        async function callGemini(prompt, systemInstruction = "") {
            if (!apiKey) { checkApiKey(); return "APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚"; }

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const maxRetries = 3;
            let attempt = 0;
            
            while (attempt < maxRetries) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            systemInstruction: { parts: [{ text: systemInstruction }] }
                        })
                    });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    return data.candidates[0].content.parts[0].text;
                } catch (e) {
                    attempt++;
                    if (attempt === maxRetries) throw e;
                    await new Promise(r => setTimeout(r, 1000 * Math.pow(2, attempt)));
                }
            }
        }

        // JSON Generation
        async function callGeminiJSON(prompt, systemInstruction = "") {
            if (!apiKey) { checkApiKey(); return null; }
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: systemInstruction }] },
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });
                const data = await response.json();
                return JSON.parse(data.candidates[0].content.parts[0].text);
            } catch (e) {
                console.error("JSON Gen Error", e);
                return null;
            }
        }

        // TTS
        async function callGeminiTTS(text, voiceName = "Kore") {
            if (!apiKey) { checkApiKey(); return null; }
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: text }] }],
                        generationConfig: {
                            responseModalities: ["AUDIO"],
                            speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: voiceName } } }
                        }
                    })
                });
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.inlineData;
            } catch (e) {
                console.error("TTS Error:", e);
                return null;
            }
        }

        // --- AUDIO PLAYER ---
        let audioContext = null;
        let currentSource = null;

        async function playAudioFromBase64(base64Data, mimeType) {
            if (currentSource) { currentSource.stop(); currentSource = null; }
            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();

            const binaryString = window.atob(base64Data);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) bytes[i] = binaryString.charCodeAt(i);

            let sampleRate = 24000;
            const rateMatch = mimeType.match(/rate=(\d+)/);
            if (rateMatch) sampleRate = parseInt(rateMatch[1]);

            const int16View = new Int16Array(bytes.buffer);
            const float32Buffer = audioContext.createBuffer(1, int16View.length, sampleRate);
            const channelData = float32Buffer.getChannelData(0);
            for (let i = 0; i < int16View.length; i++) channelData[i] = int16View[i] / 32768.0;

            const source = audioContext.createBufferSource();
            source.buffer = float32Buffer;
            source.connect(audioContext.destination);
            source.start(0);
            currentSource = source;
            source.onended = () => {
                document.getElementById('tts-btn').innerHTML = '<i class="fas fa-volume-up"></i> <span>èª­ã‚€</span>';
                currentSource = null;
            };
        }

        // --- DATA ---
        const pages = [
            {
                title: "ã‚·ãƒ¼ã‚ªãƒ¼ãƒ„ãƒ¼ãã‚“ã®\nã‚·ãƒ¥ãƒ¯ã‚·ãƒ¥ãƒ¯å¤‰èº«ã®æ—…ï¼",
                rawText: "ã“ã‚Œã¯ã€äºŒé…¸åŒ–ç‚­ç´ ï¼ˆã‚·ãƒ¼ã‚ªãƒ¼ãƒ„ãƒ¼ï¼‰ãŒã€è‡ªç„¶ç•Œã¨ä½“ã®ä¸­ã§ãã‚Šåºƒã’ã‚‹ã€ã€Œè¡Œã£ã¦å¸°ã£ã¦ãã‚‹ã€ãµã—ããªå¤‰èº«ã®ç‰©èªã€‚",
                text: "ã“ã‚Œã¯ã€äºŒé…¸åŒ–ç‚­ç´ ï¼ˆã‚·ãƒ¼ã‚ªãƒ¼ãƒ„ãƒ¼ï¼‰ãŒã€è‡ªç„¶ç•Œã¨ä½“ã®ä¸­ã§ãã‚Šåºƒã’ã‚‹ã€ã€Œè¡Œã£ã¦å¸°ã£ã¦ãã‚‹ã€ãµã—ããªå¤‰èº«ã®ç‰©èªã€‚",
                sceneType: "cover",
                bgColor: "bg-sky-200"
            },
            {
                title: "ã¼ãã¯ã‚¬ã‚¹ï¼",
                rawText: "ã¼ãã®åå‰ã¯ã€Œã‚·ãƒ¼ã‚ªãƒ¼ãƒ„ãƒ¼ï¼ˆCO2ï¼‰ã€ã€‚ã¿ã‚“ãªã¯ã€ŒäºŒé…¸åŒ–ç‚­ç´ ã€ã£ã¦å‘¼ã¶ã­ã€‚ã¼ãã¯ç©ºæ°—ä¸­ã‚’ãƒ•ãƒ¯ãƒ•ãƒ¯è‡ªç”±ã«é£›ã³å›ã‚‹ã®ãŒå¤§å¥½ããªã€Œã‚¬ã‚¹ã€ãªã‚“ã ã€‚ã§ã‚‚ã­ã€ã¼ãã«ã¯ã™ã”ã„ç‰¹æŠ€ãŒã‚ã‚‹ã‚“ã ã‚ˆã€‚ãã‚Œã¯ã€ã€Œæ°´ã«å‡ºä¼šã†ã¨å¤‰èº«ã™ã‚‹ã€ ã“ã¨ï¼",
                text: "ã¼ãã®åå‰ã¯ã€Œã‚·ãƒ¼ã‚ªãƒ¼ãƒ„ãƒ¼ï¼ˆCO<sub>2</sub>ï¼‰ã€ã€‚<br>ã¿ã‚“ãªã¯ã€ŒäºŒé…¸åŒ–ç‚­ç´ ã€ã£ã¦å‘¼ã¶ã­ã€‚<br>ã¼ãã¯ç©ºæ°—ä¸­ã‚’ãƒ•ãƒ¯ãƒ•ãƒ¯è‡ªç”±ã«é£›ã³å›ã‚‹ã®ãŒå¤§å¥½ããªã€Œã‚¬ã‚¹ã€ãªã‚“ã ã€‚<br><br>ã§ã‚‚ã­ã€ã¼ãã«ã¯ã™ã”ã„ç‰¹æŠ€ãŒã‚ã‚‹ã‚“ã ã‚ˆã€‚<br>ãã‚Œã¯ã€<span class='text-blue-500 font-bold'>ã€Œæ°´ã«å‡ºä¼šã†ã¨å¤‰èº«ã™ã‚‹ã€</span> ã“ã¨ï¼",
                sceneType: "intro",
                bgColor: "bg-blue-50"
            },
            {
                title: "ã‚µã‚¤ãƒ€ãƒ¼å·¥å ´ã§ã¤ã‹ã¾ã£ãŸï¼",
                rawText: "ã‚ã‚‹æ—¥ã€ã¼ãã¯ã‚µã‚¤ãƒ€ãƒ¼å·¥å ´ã§ã¤ã‹ã¾ã£ã¡ã‚ƒã£ãŸã€‚ã€Œå†·ãŸã„æ°´ã®ä¸­ã«ã€å…¥ã‚Œã ã£ã¦ï¼ï¼Ÿã€ã™ã”ã„åœ§åŠ›ã§ã€æ°´ï¼ˆãƒŸã‚ºã•ã‚“ï¼‰ã®ä¸­ã«æŠ¼ã—è¾¼ã¾ã‚ŒãŸã‚“ã ã€‚ã€Œã‚‚ã†ã€ã“ã†ãªã£ãŸã‚‰å¤‰èº«ã ï¼ã€",
                text: "ã‚ã‚‹æ—¥ã€ã¼ãã¯ã‚µã‚¤ãƒ€ãƒ¼å·¥å ´ã§ã¤ã‹ã¾ã£ã¡ã‚ƒã£ãŸã€‚<br>ã€Œå†·ãŸã„æ°´ã®ä¸­ã«ã€å…¥ã‚Œã ã£ã¦ï¼ï¼Ÿã€<br><br>ã™ã”ã„åœ§åŠ›ã§ã€æ°´ï¼ˆãƒŸã‚ºã•ã‚“ï¼‰ã®ä¸­ã«æŠ¼ã—è¾¼ã¾ã‚ŒãŸã‚“ã ã€‚<br>ã€Œã‚‚ã†ã€ã“ã†ãªã£ãŸã‚‰å¤‰èº«ã ï¼ã€",
                sceneType: "factory",
                bgColor: "bg-blue-200"
            },
            {
                title: "ç¬¬1ã®å¤‰èº«ï¼ãƒ”ãƒªãƒƒã¨ãã‚“èª•ç”Ÿ",
                rawText: "ã¼ãã¯ãƒŸã‚ºã•ã‚“ã¨åˆä½“ã—ã¦ã€å§¿ã‚’å¤‰ãˆãŸã‚“ã ã€‚ã€Œã¨ã‰ã£ï¼ å¤‰èº«ï¼ ã‚¤ã‚ªãƒ³ãƒ»ãƒ•ã‚©ãƒ¼ãƒ ï¼ã€ã™ã‚‹ã¨ã€ã¼ãã®ä½“ã‹ã‚‰ã€å°ã•ãã¦å…ƒæ°—ãªã€Œãƒ”ãƒªãƒƒã¨ãã‚“ï¼ˆæ°´ç´ ã‚¤ã‚ªãƒ³ï¼‰ã€ãŒé£›ã³å‡ºã—ãŸï¼ã“ã„ã¤ãŒèˆŒã«è§¦ã‚‹ã¨ã€ã¿ã‚“ãªã¯ã€Œã‚·ãƒ¥ãƒ¯ã‚·ãƒ¥ãƒ¯ã™ã‚‹ï¼ã€ã€Œã™ã£ã±ã„ï¼ã€ã£ã¦æ„Ÿã˜ã‚‹ã‚“ã ã‚ˆã€‚",
                text: "ã¼ãã¯ãƒŸã‚ºã•ã‚“ã¨åˆä½“ã—ã¦ã€å§¿ã‚’å¤‰ãˆãŸã‚“ã ã€‚<br><br><span class='text-yellow-500 font-bold text-2xl'>ã€Œã¨ã‰ã£ï¼ å¤‰èº«ï¼ ã‚¤ã‚ªãƒ³ãƒ»ãƒ•ã‚©ãƒ¼ãƒ ï¼ã€</span><br><br>ã™ã‚‹ã¨ã€ã¼ãã®ä½“ã‹ã‚‰ã€å°ã•ãã¦å…ƒæ°—ãªã€Œãƒ”ãƒªãƒƒã¨ãã‚“ï¼ˆæ°´ç´ ã‚¤ã‚ªãƒ³ H<sup>+</sup>ï¼‰ã€ãŒé£›ã³å‡ºã—ãŸï¼<br>ã“ã„ã¤ãŒèˆŒã«è§¦ã‚‹ã¨ã€ã¿ã‚“ãªã¯ã€Œã‚·ãƒ¥ãƒ¯ã‚·ãƒ¥ãƒ¯ã™ã‚‹ï¼ã€ã€Œã™ã£ã±ã„ï¼ã€ã£ã¦æ„Ÿã˜ã‚‹ã‚“ã ã‚ˆã€‚",
                sceneType: "transformation1",
                bgColor: "bg-yellow-50"
            },
            {
                title: "é€ƒã’ã‚ï¼å…ƒã®å§¿ã¸",
                rawText: "ã§ã‚‚ã€ã¼ãã‚‰ã¯æ°´ã®ä¸­ãŒã‚ã‚“ã¾ã‚Šå¥½ãã˜ã‚ƒãªã„ã€‚ãƒ•ã‚¿ãŒé–‹ã„ã¦åœ§åŠ›ãŒå¼±ã¾ã‚‹ã¨â€¦â€¦ã€Œä»Šã ï¼ å…ƒã®å§¿ã«æˆ»ã‚Œï¼ã€ãƒ”ãƒªãƒƒã¨ãã‚“ãŸã¡ã¯ã€ã‚ã£ã¨ã„ã†é–“ã«åˆä½“ã—ã¦ã€å…ƒã®ã‚¬ã‚¹ã®å§¿ã«æˆ»ã£ã¦ç©ºã¸é€ƒã’å‡ºã™ã‚“ã ã€‚æ°—ãŒæŠœã‘ãŸã‚µã‚¤ãƒ€ãƒ¼ãŒç”˜ã„æ°´ã«æˆ»ã‚‹ã®ã¯ã€ã¼ãã‚‰ãŒé€ƒã’ã¡ã‚ƒã£ãŸã‹ã‚‰ãªã‚“ã ã­ã€‚",
                text: "ã§ã‚‚ã€ã¼ãã‚‰ã¯æ°´ã®ä¸­ãŒã‚ã‚“ã¾ã‚Šå¥½ãã˜ã‚ƒãªã„ã€‚<br>ãƒ•ã‚¿ãŒé–‹ã„ã¦åœ§åŠ›ãŒå¼±ã¾ã‚‹ã¨â€¦â€¦<br><br>ã€Œä»Šã ï¼ å…ƒã®å§¿ã«æˆ»ã‚Œï¼ã€<br><br>ãƒ”ãƒªãƒƒã¨ãã‚“ãŸã¡ã¯ã€ã‚ã£ã¨ã„ã†é–“ã«åˆä½“ã—ã¦ã€å…ƒã®ã‚¬ã‚¹ã®å§¿ï¼ˆCO<sub>2</sub>ï¼‰ã«æˆ»ã£ã¦ç©ºã¸é€ƒã’å‡ºã™ã‚“ã ã€‚<br>æ°—ãŒæŠœã‘ãŸã‚µã‚¤ãƒ€ãƒ¼ãŒç”˜ã„æ°´ã«æˆ»ã‚‹ã®ã¯ã€ã¼ãã‚‰ãŒé€ƒã’ã¡ã‚ƒã£ãŸã‹ã‚‰ãªã‚“ã ã­ã€‚",
                sceneType: "escape",
                bgColor: "bg-white"
            },
            {
                title: "èˆå°ã¯äººé–“ã®ä½“ã®ä¸­ã¸",
                rawText: "ã•ã¦ã€ã“ã®ã€Œè¡Œã£ãŸã‚Šæ¥ãŸã‚Šã®å¤‰èº«ã€ãŒä¸€ç•ªæ´»èºã™ã‚‹ã®ã¯ã€å®Ÿã¯ã‚­ãƒŸã®ä½“ã®ä¸­ãªã‚“ã ã€‚ã‚­ãƒŸãŒé‹å‹•ã—ãŸã‚Šå‹‰å¼·ã—ãŸã‚Šã™ã‚‹ã¨ã€ä½“ã®ç´°èƒã§ã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒä½¿ã‚ã‚Œã¦ã€ã‚´ãƒŸã¨ã—ã¦ã¼ãï¼ˆã‚·ãƒ¼ã‚ªãƒ¼ãƒ„ãƒ¼ï¼‰ãŒãŸãã•ã‚“ç”Ÿã¾ã‚Œã‚‹ã€‚ã“ã®ã‚´ãƒŸã¯ã€è‚ºã¾ã§é‹ã‚“ã§æ¯ã¨ã—ã¦æ¨ã¦ãªãã‚ƒã„ã‘ãªã„ã‚“ã ã‘ã©â€¦â€¦ã€‚",
                text: "ã•ã¦ã€ã“ã®ã€Œè¡Œã£ãŸã‚Šæ¥ãŸã‚Šã®å¤‰èº«ã€ãŒä¸€ç•ªæ´»èºã™ã‚‹ã®ã¯ã€å®Ÿã¯ã‚­ãƒŸã®ä½“ã®ä¸­ãªã‚“ã ã€‚<br><br>ã‚­ãƒŸãŒé‹å‹•ã—ãŸã‚Šå‹‰å¼·ã—ãŸã‚Šã™ã‚‹ã¨ã€ä½“ã®ç´°èƒã§ã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒä½¿ã‚ã‚Œã¦ã€ã‚´ãƒŸã¨ã—ã¦ã¼ãï¼ˆã‚·ãƒ¼ã‚ªãƒ¼ãƒ„ãƒ¼ï¼‰ãŒãŸãã•ã‚“ç”Ÿã¾ã‚Œã‚‹ã€‚<br>ã“ã®ã‚´ãƒŸã¯ã€è‚ºã¾ã§é‹ã‚“ã§æ¯ã¨ã—ã¦æ¨ã¦ãªãã‚ƒã„ã‘ãªã„ã‚“ã ã‘ã©â€¦â€¦ã€‚",
                sceneType: "body_intro",
                bgColor: "bg-red-50"
            },
            {
                title: "è¡€ç®¡ã®ä¸­ã®ãƒ”ãƒ³ãƒï¼",
                rawText: "ã“ã“ã§å¤§ãƒ”ãƒ³ãƒï¼ã‚‚ã—ã€ã¼ããŒã€Œã‚¬ã‚¹ï¼ˆæ³¡ï¼‰ã€ã®å§¿ã®ã¾ã¾è¡€ç®¡ã«å…¥ã£ãŸã‚‰ã€ã©ã†ãªã‚‹ã¨æ€ã†ï¼Ÿãã†ã€è¡€æ¶²ãŒã‚µã‚¤ãƒ€ãƒ¼ã¿ãŸã„ã«æ³¡ã ã‚‰ã‘ã«ãªã£ã¦ã€è¡€ç®¡ãŒè©°ã¾ã£ã¡ã‚ƒã†ï¼ã“ã‚Œã˜ã‚ƒã‚ã€å‘½ã«ã‹ã‹ã‚ã‚‹ã‚ˆï¼",
                text: "ã“ã“ã§å¤§ãƒ”ãƒ³ãƒï¼<br>ã‚‚ã—ã€ã¼ããŒã€Œã‚¬ã‚¹ï¼ˆæ³¡ï¼‰ã€ã®å§¿ã®ã¾ã¾è¡€ç®¡ã«å…¥ã£ãŸã‚‰ã€ã©ã†ãªã‚‹ã¨æ€ã†ï¼Ÿ<br><br>ãã†ã€è¡€æ¶²ãŒã‚µã‚¤ãƒ€ãƒ¼ã¿ãŸã„ã«æ³¡ã ã‚‰ã‘ã«ãªã£ã¦ã€è¡€ç®¡ãŒè©°ã¾ã£ã¡ã‚ƒã†ï¼<br>ã“ã‚Œã˜ã‚ƒã‚ã€å‘½ã«ã‹ã‹ã‚ã‚‹ã‚ˆï¼",
                sceneType: "vessel_danger",
                bgColor: "bg-red-200"
            },
            {
                title: "ç¬¬2ã®å¤‰èº«ï¼è¡€æ¶²ã«ä¹—ã‚‹ãŸã‚ã«",
                rawText: "ãã“ã§ã€ã‚ã®å¤‰èº«é­”æ³•ã‚’ä½¿ã†ã‚“ã ï¼è¡€æ¶²ã®ä¸­ã®ã€Œæ°´ã€ã‚’åˆ©ç”¨ã—ã¦ã€ã¼ãã¯å§¿ã‚’å¤‰ãˆã‚‹ã€‚ã€Œå¤‰èº«ï¼ ã‚¤ã‚ªãƒ³ãƒ»ãƒ•ã‚©ãƒ¼ãƒ ï¼ã€ã‚¬ã‚¹ã‹ã‚‰æ¶²ä½“ã«æº¶ã‘ã‚‹å§¿ã«ãªã‚Œã°ã€ã‚‚ã†æ³¡ã¯å‡ºãªã„ã€‚ã¼ãã¯å§¿ã‚’å¤‰ãˆã‚‹ã“ã¨ã§ã€å®‰å…¨ã«è¡€æ¶²ã®æµã‚Œã«ä¹—ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚“ã ã€‚",
                text: "ãã“ã§ã€ã‚ã®å¤‰èº«é­”æ³•ã‚’ä½¿ã†ã‚“ã ï¼<br>è¡€æ¶²ã®ä¸­ã®ã€Œæ°´ã€ã‚’åˆ©ç”¨ã—ã¦ã€ã¼ãã¯å§¿ã‚’å¤‰ãˆã‚‹ã€‚<br><br><span class='text-blue-600 font-bold'>ã€Œå¤‰èº«ï¼ ã‚¤ã‚ªãƒ³ãƒ»ãƒ•ã‚©ãƒ¼ãƒ ï¼ã€</span><br><br>ã‚¬ã‚¹ã‹ã‚‰æ¶²ä½“ã«æº¶ã‘ã‚‹å§¿ï¼ˆã‚¤ã‚ªãƒ³ï¼‰ã«ãªã‚Œã°ã€ã‚‚ã†æ³¡ã¯å‡ºãªã„ã€‚<br>ã¼ãã¯å§¿ã‚’å¤‰ãˆã‚‹ã“ã¨ã§ã€å®‰å…¨ã«è¡€æ¶²ã®æµã‚Œã«ä¹—ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚“ã ã€‚",
                sceneType: "transformation2",
                bgColor: "bg-red-100"
            },
            {
                title: "è‚ºã«åˆ°ç€ã€æœ€å¾Œã®å¤‰èº«",
                rawText: "ã•ã‚ã€çµ‚ç‚¹ã®ã€Œè‚ºã€ã«åˆ°ç€ã ã€‚ã“ã“ã§ã¯ã€æ¯ã‚’åã„ã¦ã€ã¼ãã‚’å¤–ã«æ¨ã¦ãªãã‚ƒã„ã‘ãªã„ã€‚ã§ã‚‚ã€æ¶²ä½“ã®å§¿ã®ã¾ã¾ã˜ã‚ƒã€æ¯ã¨ä¸€ç·’ã«å¤–ã«å‡ºã‚‰ã‚Œãªã„ã‚ˆã­ï¼Ÿ",
                text: "ã•ã‚ã€çµ‚ç‚¹ã®ã€Œè‚ºã€ã«åˆ°ç€ã ã€‚<br>ã“ã“ã§ã¯ã€æ¯ã‚’åã„ã¦ã€ã¼ãã‚’å¤–ã«æ¨ã¦ãªãã‚ƒã„ã‘ãªã„ã€‚<br><br>ã§ã‚‚ã€æ¶²ä½“ã®å§¿ã®ã¾ã¾ã˜ã‚ƒã€æ¯ã¨ä¸€ç·’ã«å¤–ã«å‡ºã‚‰ã‚Œãªã„ã‚ˆã­ï¼Ÿ",
                sceneType: "lungs",
                bgColor: "bg-pink-100"
            },
            {
                title: "ã•ã‚ˆã†ãªã‚‰ï¼å…ƒã®ã‚¬ã‚¹ã«æˆ»ã‚‹",
                rawText: "ã“ã“ã§æœ€å¾Œã®å¤‰èº«ã ï¼ã€Œæˆ»ã‚Œï¼ ã‚¬ã‚¹ãƒ»ãƒ•ã‚©ãƒ¼ãƒ ï¼ã€è‚ºã«æ¥ã‚‹ã¨ã€ã¼ãã¯å…ƒã®ã‚¬ã‚¹ã®å§¿ã«æˆ»ã‚‹ã€‚ãã—ã¦ã€ã‚­ãƒŸãŒã€Œã¯ããƒ¼ã£ã€ã¨æ¯ã‚’åãã®ã¨ä¸€ç·’ã«ã€ä½“ã®å¤–ã¸é£›ã³å‡ºã—ã¦ã„ãã‚“ã ã€‚ãƒã‚¤ãƒãƒ¼ã‚¤ï¼",
                text: "ã“ã“ã§æœ€å¾Œã®å¤‰èº«ã ï¼<br><br><span class='text-gray-600 font-bold text-2xl'>ã€Œæˆ»ã‚Œï¼ ã‚¬ã‚¹ãƒ»ãƒ•ã‚©ãƒ¼ãƒ ï¼ã€</span><br><br>è‚ºã«æ¥ã‚‹ã¨ã€ã¼ãã¯å…ƒã®ã‚¬ã‚¹ã®å§¿ï¼ˆCO<sub>2</sub>ï¼‰ã«æˆ»ã‚‹ã€‚<br>ãã—ã¦ã€ã‚­ãƒŸãŒã€Œã¯ããƒ¼ã£ã€ã¨æ¯ã‚’åãã®ã¨ä¸€ç·’ã«ã€ä½“ã®å¤–ã¸é£›ã³å‡ºã—ã¦ã„ãã‚“ã ã€‚<br>ãƒã‚¤ãƒãƒ¼ã‚¤ï¼",
                sceneType: "exhale",
                bgColor: "bg-sky-100"
            },
            {
                title: "é­”æ³•ã®çŸ¢å°",
                rawText: "ã‚¬ã‚¹ã«ãªã£ãŸã‚Šã€æ¶²ä½“ã«æº¶ã‘ã‚‹å§¿ã«ãªã£ãŸã‚Šã€‚ã¼ãã‚‰ã¯ç’°å¢ƒã«åˆã‚ã›ã¦ã€å§¿ã‚’ã€Œè¡Œã£ãŸã‚Šæ¥ãŸã‚Šã€ã—ã¦ã„ã‚‹ã€‚äºŒé…¸åŒ–ç‚­ç´ ãƒ—ãƒ©ã‚¹æ°´ã¯ã€æ°´ç´ ã‚¤ã‚ªãƒ³ãƒ—ãƒ©ã‚¹é‡ç‚­é…¸ã‚¤ã‚ªãƒ³ã€‚ã“ã®ã€Œä¸¡å‘ãã®çŸ¢å°ã€ã¯ã€ãŠã„ã—ã„ã‚µã‚¤ãƒ€ãƒ¼ã‚’ä½œã‚‹ãŸã‚ã€ãã—ã¦ä½•ã‚ˆã‚Šã€ã‚­ãƒŸãŒå…ƒæ°—ã«ç”Ÿãã¦ã„ããŸã‚ã«ã€ãªãã¦ã¯ãªã‚‰ãªã„ã€Œå‘½ã®ãƒãƒ©ãƒ³ã‚¹ã®é­”æ³•ã€ãªã‚“ã ã‚ˆã€‚",
                text: "ã‚¬ã‚¹ã«ãªã£ãŸã‚Šã€æ¶²ä½“ã«æº¶ã‘ã‚‹å§¿ã«ãªã£ãŸã‚Šã€‚<br>ã¼ãã‚‰ã¯ç’°å¢ƒã«åˆã‚ã›ã¦ã€å§¿ã‚’ã€Œè¡Œã£ãŸã‚Šæ¥ãŸã‚Šã€ã—ã¦ã„ã‚‹ã€‚<br><br><div class='text-center text-xl md:text-2xl bg-white p-4 rounded-xl border-2 border-sky-300 my-4 shadow-sm'>CO<sub>2</sub> + H<sub>2</sub>O <span class='text-red-500 font-black'>â‡„</span> H<sup>+</sup> + HCO<sub>3</sub><sup>-</sup></div><br>ã“ã®ã€Œä¸¡å‘ãã®çŸ¢å°ï¼ˆâ‡„ï¼‰ã€ã¯ã€ãŠã„ã—ã„ã‚µã‚¤ãƒ€ãƒ¼ã‚’ä½œã‚‹ãŸã‚ã€ãã—ã¦ä½•ã‚ˆã‚Šã€ã‚­ãƒŸãŒå…ƒæ°—ã«ç”Ÿãã¦ã„ããŸã‚ã«ã€ãªãã¦ã¯ãªã‚‰ãªã„<span class='text-pink-500 font-bold'>ã€Œå‘½ã®ãƒãƒ©ãƒ³ã‚¹ã®é­”æ³•ã€</span>ãªã‚“ã ã‚ˆã€‚",
                sceneType: "end",
                bgColor: "bg-gradient-to-r from-blue-100 to-pink-100"
            }
        ];

        let currentPage = 0;
        let isEnglishMode = false;

        // --- CORE FUNCTIONS ---
        function renderPage() {
            const page = pages[currentPage];
            
            // UI Update
            document.getElementById('page-title').innerText = page.title;
            
            // Check translation state
            if (isEnglishMode && page.translatedText) {
                document.getElementById('page-text').innerHTML = page.translatedText;
            } else if (isEnglishMode && !page.translatedText) {
                // If English mode is on but no translation exists, trigger translation
                document.getElementById('page-text').innerHTML = '<span class="loader border-indigo-200 border-t-indigo-600 w-6 h-6"></span> Translating...';
                translateCurrentPage();
            } else {
                document.getElementById('page-text').innerHTML = page.text;
            }

            document.getElementById('page-number').innerText = `Page ${currentPage + 1} / ${pages.length}`;
            document.getElementById('illustration-area').className = `w-full md:w-1/2 h-1/2 md:h-full relative overflow-hidden flex items-center justify-center border-b-4 md:border-b-0 md:border-r-4 border-white/20 transition-colors duration-700 ${page.bgColor} group`;
            
            document.getElementById('prev-btn').disabled = currentPage === 0;
            document.getElementById('next-btn').innerHTML = currentPage === pages.length - 1 ? 'ãŠã—ã¾ã„ <i class="fas fa-check"></i>' : 'æ¬¡ã¸ <i class="fas fa-arrow-right"></i>';

            // Reset TTS Button
            resetTTSButton();

            // Animation
            const textEl = document.getElementById('page-text');
            textEl.classList.remove('fade-in');
            void textEl.offsetWidth; 
            textEl.classList.add('fade-in');

            // Render Scene
            renderScene(page.sceneType);
            
            // Reset Chat Context
            initChat();
        }

        function resetTTSButton() {
            if (currentSource) { currentSource.stop(); currentSource = null; }
            const btn = document.getElementById('tts-btn');
            btn.innerHTML = '<i class="fas fa-volume-up"></i> <span>èª­ã‚€</span>';
            btn.classList.remove('animate-pulse');
        }

        function nextPage() {
            if (currentPage < pages.length - 1) { currentPage++; renderPage(); }
        }

        function prevPage() {
            if (currentPage > 0) { currentPage--; renderPage(); }
        }

        // --- Translation Logic ---
        async function toggleEnglish() {
            const btn = document.getElementById('translate-btn');
            isEnglishMode = !isEnglishMode;

            if (isEnglishMode) {
                btn.innerHTML = '<i class="fas fa-language"></i> <span>æ—¥æœ¬èªã«æˆ»ã™</span>';
                btn.classList.replace('bg-indigo-100', 'bg-indigo-600');
                btn.classList.replace('text-indigo-600', 'text-white');
                renderPage(); // Will trigger translation if needed
            } else {
                btn.innerHTML = '<i class="fas fa-language"></i> <span>English</span>';
                btn.classList.replace('bg-indigo-600', 'bg-indigo-100');
                btn.classList.replace('text-white', 'text-indigo-600');
                renderPage(); // Restore Japanese
            }
        }

        async function translateCurrentPage() {
            const page = pages[currentPage];
            const systemPrompt = "Translate the following text from a children's science picture book into simple, natural English for a 6th grader. Keep formatting like <br> or <span>.";
            
            try {
                const translated = await callGemini(page.text, systemPrompt);
                page.translatedText = translated; // Cache it
                if (isEnglishMode) {
                    document.getElementById('page-text').innerHTML = translated;
                }
            } catch (e) {
                document.getElementById('page-text').innerHTML = "Translation failed. Please try again.";
                console.error(e);
            }
        }

        // --- Quiz Logic ---
        function startQuiz() {
            const modal = document.getElementById('quiz-modal');
            modal.classList.remove('hidden');
            generateQuiz();
        }

        function closeQuiz() {
            document.getElementById('quiz-modal').classList.add('hidden');
        }

        async function generateQuiz() {
            // Reset UI
            document.getElementById('quiz-loading').classList.remove('hidden');
            document.getElementById('quiz-question-container').classList.add('hidden');
            document.getElementById('quiz-result').classList.add('hidden');

            const page = pages[currentPage];
            const prompt = `Based on the following text from a science picture book for 6th graders, generate 1 multiple-choice quiz.
            
            Text: "${page.rawText}"
            
            Return ONLY a valid JSON object with this structure:
            {
                "question": "Question text in Japanese",
                "options": ["Option 1", "Option 2", "Option 3"],
                "correctIndex": 0,
                "explanation": "Brief explanation in Japanese suitable for a child."
            }`;

            try {
                const quizData = await callGeminiJSON(prompt, "You are a helpful education assistant.");
                if (quizData) {
                    renderQuiz(quizData);
                } else {
                    throw new Error("No data");
                }
            } catch (e) {
                document.getElementById('quiz-body').innerHTML = '<p class="text-center text-red-500">ã‚¯ã‚¤ã‚ºã‚’ä½œã‚Œãªã‹ã£ãŸã‚ˆã€‚ã‚‚ã†ä¸€å›è©¦ã—ã¦ã­ï¼</p>';
            }
        }

        function renderQuiz(data) {
            document.getElementById('quiz-loading').classList.add('hidden');
            document.getElementById('quiz-question-container').classList.remove('hidden');
            
            document.getElementById('quiz-question').innerText = "Q. " + data.question;
            const optionsContainer = document.getElementById('quiz-options');
            optionsContainer.innerHTML = '';

            data.options.forEach((opt, index) => {
                const btn = document.createElement('button');
                btn.className = "quiz-option w-full text-left p-4 rounded-xl border-2 border-gray-200 hover:border-yellow-400 hover:bg-yellow-50 transition-all font-bold text-gray-700";
                btn.innerText = `${index + 1}. ${opt}`;
                btn.onclick = () => checkAnswer(index, data);
                optionsContainer.appendChild(btn);
            });
        }

        function checkAnswer(selectedIndex, data) {
            const resultBox = document.getElementById('quiz-result');
            const resultTitle = document.getElementById('quiz-result-title');
            const explanation = document.getElementById('quiz-explanation');
            
            resultBox.classList.remove('hidden');
            document.getElementById('quiz-options').classList.add('pointer-events-none', 'opacity-50'); // Disable buttons

            if (selectedIndex === data.correctIndex) {
                resultTitle.innerText = "âœ¨ ã›ã„ã‹ã„ï¼ âœ¨";
                resultTitle.className = "font-black text-2xl mb-2 text-center text-green-500";
                playTTS_Simple("æ­£è§£ï¼ã™ã”ã„ã­ï¼");
            } else {
                resultTitle.innerText = "æ®‹å¿µï¼ã¯ãšã‚Œ...";
                resultTitle.className = "font-black text-2xl mb-2 text-center text-red-500";
                playTTS_Simple("æ®‹å¿µã€‚ç­”ãˆã¯" + (data.correctIndex + 1) + "ç•ªã ã‚ˆã€‚");
            }
            explanation.innerText = data.explanation;
        }

        async function playTTS_Simple(text) {
             const audioData = await callGeminiTTS(text, "Kore");
             if(audioData) playAudioFromBase64(audioData.data, audioData.mimeType);
        }

        // --- Chat Logic ---
        function initChat() {
            const sceneType = pages[currentPage].sceneType;
            const greetings = {
                'factory': "ã‚ã‚ï¼ã“ã“ã¯ã©ã“ï¼ï¼Ÿè‹¦ã—ã„ã‚ˆã€œï¼ãã¿ã‚‚ãã†æ€ã†ï¼Ÿ",
                'transformation1': "è¦‹ã¦è¦‹ã¦ï¼å¤‰èº«ã—ã¡ã‚ƒã£ãŸï¼ã™ã”ã„ã§ã—ã‚‡ï¼Ÿ",
                'vessel_danger': "ã†ã‚ã£ã€ã“ã“ã¯ç‹­ã„è¡€ç®¡ã®ä¸­ã ï¼æ³¡ã«ãªã£ã¡ã‚ƒãƒ€ãƒ¡ã ã‚ˆã­ï¼Ÿ",
                'lungs': "ã‚„ã£ã¨è‚ºã«ã¤ã„ãŸã‚ˆã€œã€‚ã“ã“ã§ä½•ã™ã‚‹ã‹ã‚ã‹ã‚‹ï¼Ÿ",
                'default': "ã‚„ã‚ï¼ã¼ãã¯ã‚·ãƒ¼ã‚ªãƒ¼ãƒ„ãƒ¼ã€‚ã“ã®ãƒšãƒ¼ã‚¸ã®ã“ã¨ãªã‚‰ãªã‚“ã§ã‚‚èã„ã¦ã­ï¼"
            };
            const greeting = greetings[sceneType] || greetings['default'];
            
            document.getElementById('chat-messages').innerHTML = `
                <div class="flex items-start gap-2">
                    <div class="w-8 h-8 bg-sky-200 rounded-full flex-shrink-0 flex items-center justify-center text-sky-700 text-xs font-bold">AI</div>
                    <div class="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm border border-gray-100 text-gray-700 text-sm">
                        ${greeting}
                    </div>
                </div>
            `;
        }

        function openChat() {
            const modal = document.getElementById('chat-modal');
            const content = document.getElementById('chat-content');
            modal.classList.remove('hidden');
            setTimeout(() => content.classList.remove('scale-90', 'opacity-0'), 10);
        }

        function closeChat() {
            const modal = document.getElementById('chat-modal');
            const content = document.getElementById('chat-content');
            content.classList.add('scale-90', 'opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;

            const chatBox = document.getElementById('chat-messages');
            chatBox.innerHTML += `
                <div class="flex items-start gap-2 justify-end">
                    <div class="bg-sky-500 text-white p-3 rounded-2xl rounded-tr-none shadow-sm text-sm">${message}</div>
                </div>
            `;
            input.value = '';
            chatBox.scrollTop = chatBox.scrollHeight;

            const loadingId = 'loading-' + Date.now();
            chatBox.innerHTML += `
                <div id="${loadingId}" class="flex items-start gap-2">
                    <div class="w-8 h-8 bg-sky-200 rounded-full flex-shrink-0 flex items-center justify-center text-sky-700 text-xs font-bold">AI</div>
                    <div class="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm border border-gray-100 text-gray-500 text-sm">
                        <span class="loader w-3 h-3 border-gray-200 border-t-sky-500"></span> è€ƒãˆä¸­...
                    </div>
                </div>
            `;
            chatBox.scrollTop = chatBox.scrollHeight;

            const page = pages[currentPage];
            const systemPrompt = `You are a character named "CO2-kun" (CO2) in a science picture book for 6th graders.
            Current Page Context: Title "${page.title}", Content "${page.rawText}".
            Reply to the user's question as the character. Be energetic, simple, and educational. Keep it short.`;

            try {
                const reply = await callGemini(message, systemPrompt);
                document.getElementById(loadingId).remove();
                chatBox.innerHTML += `
                    <div class="flex items-start gap-2">
                        <div class="w-8 h-8 bg-sky-200 rounded-full flex-shrink-0 flex items-center justify-center text-sky-700 text-xs font-bold">AI</div>
                        <div class="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm border border-gray-100 text-gray-700 text-sm">${reply}</div>
                    </div>
                `;
            } catch (error) {
                document.getElementById(loadingId).remove();
                chatBox.innerHTML += `<div class="flex items-start gap-2"><div class="bg-red-50 text-red-500 p-2 rounded-lg text-xs">ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿã€‚ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ã­ã€‚</div></div>`;
            }
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // --- TTS Logic ---
        async function playTTS() {
            const btn = document.getElementById('tts-btn');
            if (currentSource) { resetTTSButton(); return; }

            const page = pages[currentPage];
            const textToRead = isEnglishMode && page.translatedText ? 
                               page.translatedText.replace(/<[^>]*>/g, '') : 
                               page.rawText;
            
            btn.innerHTML = '<span class="loader border-pink-200 border-t-pink-600 w-4 h-4 mr-2"></span> æº–å‚™ä¸­...';
            const voice = isEnglishMode ? "Puck" : "Kore"; // Puck for English, Kore for Japanese
            
            const audioData = await callGeminiTTS(textToRead, voice);
            if (audioData) {
                btn.innerHTML = '<i class="fas fa-stop"></i> ã‚¹ãƒˆãƒƒãƒ—';
                btn.classList.add('animate-pulse');
                playAudioFromBase64(audioData.data, audioData.mimeType);
            } else {
                btn.innerHTML = '<i class="fas fa-exclamation-circle"></i> ã‚¨ãƒ©ãƒ¼';
                setTimeout(() => resetTTSButton(), 2000);
            }
        }

        // --- SCENE RENDERER (SVG/CSS Composition) ---
        function renderScene(type) {
            const container = document.getElementById('scene-container');
            container.innerHTML = '';

            // Helpers
            const CO2 = (x, y, scale=1) => `<div class="absolute character-float flex items-center justify-center font-bold text-white" style="left:${x}%; top:${y}%; width:${80*scale}px; height:${80*scale}px; background:#9CA3AF; border-radius:50%; box-shadow: 2px 4px 10px rgba(0,0,0,0.2);">CO<sub>2</sub><div style="position:absolute; width:10px; height:10px; bg:#333; border-radius:50%; top:25px; left:20px;"></div><div style="position:absolute; width:10px; height:10px; bg:#333; border-radius:50%; top:25px; right:20px;"></div><div style="position:absolute; width:20px; height:5px; bg:#333; border-radius:5px; bottom:20px; left:30px;"></div></div>`;
            const H2O = (x, y, scale=1) => `<div class="absolute flex items-center justify-center font-bold text-white text-xs" style="left:${x}%; top:${y}%; width:${60*scale}px; height:${60*scale}px; background:#3B82F6; border-radius:50% 50% 50% 5%; transform:rotate(-45deg); opacity:0.8;"><span style="transform:rotate(45deg);">H<sub>2</sub>O</span></div>`;
            const H_PLUS = (x, y) => `<div class="absolute character-shake flex items-center justify-center font-bold text-white text-xl z-20" style="left:${x}%; top:${y}%; width:50px; height:50px; background:#EAB308; clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);">H<sup>+</sup></div>`;
            const HCO3 = (x, y) => `<div class="absolute flex items-center justify-center font-bold text-white text-sm" style="left:${x}%; top:${y}%; width:70px; height:70px; background:#10B981; border-radius:40%;">HCO<sub>3</sub><sup>-</sup></div>`;

            let html = '';
            if (type === 'cover') {
                html += CO2(40, 40, 1.5) + `<div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-9xl text-yellow-400 opacity-50 font-black z-0">â‡„</div>` + H_PLUS(70, 20) + H2O(20, 70, 1.2);
            } else if (type === 'intro') {
                html += `<div class="absolute bottom-0 w-full h-20 bg-gray-300 flex justify-center items-end text-gray-500 font-bold">å·¥å ´</div>` + CO2(20, 60, 0.8) + CO2(50, 40, 1.0) + CO2(80, 20, 0.6);
            } else if (type === 'factory') {
                html += `<div class="absolute inset-0 bg-blue-400 opacity-20"></div>` + H2O(10, 10) + H2O(80, 80) + H2O(20, 80) + H2O(70, 20) + CO2(40, 40, 1.2) + `<div class="absolute top-10 left-10 text-4xl">ğŸ’¦</div><div class="absolute top-10 right-10 text-4xl">ğŸ’¦</div>`;
            } else if (type === 'transformation1') {
                html += `<div class="absolute inset-0 bg-blue-100"></div><div class="absolute top-1/2 left-1/4 text-4xl text-gray-400">CO<sub>2</sub></div><div class="absolute top-1/2 left-1/2 text-4xl">â¡</div>` + H_PLUS(60, 30) + HCO3(70, 60) + `<div class="absolute bottom-10 w-full text-center text-yellow-600 font-bold">ãƒ”ãƒªãƒƒã¨ãã‚“èª•ç”Ÿï¼</div>`;
            } else if (type === 'escape') {
                html += `<div class="absolute bottom-0 w-full h-1/2 bg-blue-200"></div><div class="absolute top-10 left-1/2 transform -translate-x-1/2 text-sm text-gray-500">ãƒ—ã‚·ãƒ¥ãƒƒï¼</div><div class="absolute left-1/2 top-3/4 transition-all duration-1000 -translate-y-40 opacity-50">${CO2(0,0,0.5)}</div>` + CO2(45, 20, 0.8) + CO2(60, 10, 0.6) + H2O(20, 80);
            } else if (type === 'body_intro') {
                html += `<div class="absolute inset-0 bg-red-50 flex items-center justify-center"><div class="w-32 h-32 bg-red-300 rounded-full animate-pulse flex items-center justify-center text-white font-bold">ç­‹è‚‰</div></div>` + CO2(60, 60, 0.5) + CO2(30, 20, 0.5) + CO2(70, 30, 0.5);
            } else if (type === 'vessel_danger') {
                html += `<div class="w-full h-full bg-red-200 flex flex-col items-center justify-center relative overflow-hidden"><div class="absolute w-[200%] h-32 bg-red-500 rotate-12 top-1/3 border-y-4 border-red-700"></div></div>` + CO2(40, 45, 1) + CO2(50, 42, 1) + `<div class="absolute top-1/2 left-20 text-white font-bold text-2xl z-10">è©°ã¾ã‚‹ï¼</div>`;
            } else if (type === 'transformation2') {
                html += `<div class="w-full h-full bg-red-100 relative overflow-hidden"><div class="absolute w-[200%] h-32 bg-red-400 rotate-12 top-1/3 flex items-center space-x-10 px-20 animate-pulse"></div></div>` + H_PLUS(30, 45) + HCO3(45, 50) + H_PLUS(60, 40) + `<div class="absolute bottom-10 right-10 text-red-600 font-bold">ã‚µãƒ©ã‚µãƒ©æµã‚Œã‚‹ã€œ</div>`;
            } else if (type === 'lungs') {
                html += `<div class="absolute inset-0 bg-pink-100 opacity-80 grid grid-cols-6 grid-rows-6 gap-2 p-2"><div class="bg-pink-200 rounded-full opacity-50"></div><div class="bg-pink-200 rounded-full opacity-50"></div></div>` + H_PLUS(30, 50) + HCO3(50, 50) + `<div class="absolute top-10 left-10 text-pink-500 font-bold text-xl">è‚ºï¼ˆã‚´ãƒ¼ãƒ«ï¼‰</div>`;
            } else if (type === 'exhale') {
                html += `<div class="absolute right-0 top-1/2 transform -translate-y-1/2 w-40 h-60 bg-orange-200 rounded-l-full border-4 border-white"></div>` + CO2(50, 40, 1.0) + CO2(30, 30, 0.8) + `<div class="absolute top-1/2 left-10 text-4xl rotate-180">ğŸ’¨</div>`;
            } else if (type === 'end') {
                html += CO2(20, 30, 1) + H2O(20, 70, 1) + `<div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-6xl text-gray-800 font-black">â‡„</div>` + H_PLUS(70, 30) + HCO3(70, 70);
            }
            container.innerHTML = html;
        }

        renderPage();
        checkApiKey(); // Check key on load
    </script>
</body>
</html>